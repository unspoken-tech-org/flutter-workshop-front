name: Build and Release (Windows)

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --force --tags

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.29.3"
          channel: "stable"

      - name: Flutter pub get
        run: flutter pub get

      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: Change .env to production
        run: |
          cp .env-prd .env

      - name: Build Windows Release
        run: flutter build windows --release

      - name: Extract version from pubspec.yaml
        id: get_version
        shell: pwsh
        run: |
          $content = Get-Content pubspec.yaml -Raw
          $version = ($content | Select-String -Pattern 'version:\s*(\d+\.\d+\.\d+)').Matches.Groups[1].Value
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Download and Install Inno Setup
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "innosetup-installer.exe"
          Start-Process -FilePath "innosetup-installer.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait

      - name: Compile installer (Inno Setup)
        shell: pwsh
        run: |
          $setupScript = Get-Content installer\workshopApp.iss -Raw
          $setupScript = $setupScript -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"${{ steps.get_version.outputs.VERSION }}`""
          Set-Content -Path installer\workshopApp.iss -Value $setupScript
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\workshopApp.iss

      - name: Extract release notes from annotated tag
        id: get_release_notes
        shell: pwsh
        run: |
          $tagName = "${{ github.ref_name }}"
          $tagContentArray = git cat-file -p $tagName
          $tagContent = $tagContentArray -join "`n"
          $lines = $tagContent -split '\r?\n'
          $messageStartIndex = -1
          for ($i = 0; $i -lt $lines.Length; $i++) {
            if ([string]::IsNullOrWhiteSpace($lines[$i])) {
              $messageStartIndex = $i + 1
              break
            }
          }
          $notes = "Nenhuma nota de release fornecida."
          if ($messageStartIndex -gt 0 -and $messageStartIndex -lt $lines.Length) {
            $tagMessage = ($lines[$messageStartIndex..($lines.Length-1)] -join "`n").Trim()
            if ($tagMessage -match '###\s*Novidades\s*\r?\n\r?\n([\s\S]+)') {
              $notes = $matches[1].Trim()
            } elseif ($tagMessage -match 'Release\s+[\d\.]+\s*\r?\n\r?\n([\s\S]+)') {
              $notes = $matches[1].Trim()
            } else {
              $msgLines = $tagMessage -split '\r?\n'
              if ($msgLines.Length -gt 1) {
                $tmp = ($msgLines[1..($msgLines.Length-1)] -join "`n").Trim()
                if ($tmp) { $notes = $tmp }
              } else {
                $notes = $tagMessage
              }
            }
          }
          "NOTES<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          $notes | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create GitHub Release and upload installer
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## v${{ steps.get_version.outputs.VERSION }}

            ### Novidades

            ${{ steps.get_release_notes.outputs.NOTES }}
          files: ./output/*.exe
          draft: false
          prerelease: false
